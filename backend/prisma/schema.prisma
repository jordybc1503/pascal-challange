generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  TENANT_ADMIN
  SALES_AGENT
}

enum SenderType {
  LEAD
  AGENT
  SYSTEM
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum ConversationStatus {
  OPEN
  PENDING
  CLOSED
}

enum ContentType {
  TEXT
  IMAGE
  FILE
  AUDIO
  VIDEO
}

enum WhatsAppProvider {
  META
  TWILIO
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

// ============================================
// MULTI-TENANT MODELS
// ============================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  ruc       String?  @unique // RUC/Tax ID - optional and unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // AI Configuration
  aiConfig  Json?    @map("ai_config") // { provider: "gemini", apiKey: "...", model: "...", updatePolicy: {...} }

  // Relations
  users             User[]
  leads             Lead[]
  conversations     Conversation[]
  messages          Message[]
  whatsappChannels  WhatsAppChannel[]
  whatsappCredentials WhatsAppCredential[]

  @@map("tenants")
}

model User {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  email        String
  passwordHash String   @map("password_hash")
  role         UserRole @default(SALES_AGENT)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  tenant                Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedConversations Conversation[] @relation("AssignedAgent")
  messages              Message[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

model WhatsAppChannel {
  id                String           @id @default(uuid())
  tenantId          String           @map("tenant_id")
  provider          WhatsAppProvider
  displayName       String           @map("display_name")
  phoneNumber       String           @map("phone_number")
  providerAccountId String           @map("provider_account_id") // phone_number_id for Meta, AccountSid for Twilio
  isActive          Boolean          @default(true) @map("is_active")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  credentials WhatsAppCredential?

  @@unique([tenantId, providerAccountId])
  @@index([tenantId])
  @@index([providerAccountId])
  @@map("whatsapp_channels")
}

model WhatsAppCredential {
  id                   String   @id @default(uuid())
  tenantId             String   @map("tenant_id")
  channelId            String   @map("channel_id")
  encryptedAccessToken String   @map("encrypted_access_token") @db.Text
  encryptedSecret      String?  @map("encrypted_secret") @db.Text
  webhookVerifyToken   String?  @map("webhook_verify_token")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  channel WhatsAppChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId])
  @@index([tenantId])
  @@map("whatsapp_credentials")
}

model Lead {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  name            String
  email           String?
  phone           String?
  projectInterest String?  @map("project_interest")
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([phone])
  @@map("leads")
}

model Conversation {
  id                    String              @id @default(uuid())
  tenantId              String              @map("tenant_id")
  leadId                String              @map("lead_id")
  assignedAgentId       String?             @map("assigned_agent_id")
  status                ConversationStatus  @default(OPEN)
  lastMessageAt         DateTime?           @map("last_message_at")
  lastMessageSenderType SenderType?         @map("last_message_sender_type")
  lastAgentReplyAt      DateTime?           @map("last_agent_reply_at")

  // AI Fields
  aiSummary             String?             @map("ai_summary") @db.Text
  aiSummaryVersion      Int                 @default(0) @map("ai_summary_version")
  aiSummaryUpdatedAt    DateTime?           @map("ai_summary_updated_at")
  aiPriority            Priority?           @map("ai_priority")
  aiTags                String[]            @default([]) @map("ai_tags")
  aiMetadata            Json?               @map("ai_metadata") // { priorityReason: "...", tagConfidences: {...}, lastAnalyzedMessageId: "..." }
  aiUpdatedAt           DateTime?           @map("ai_updated_at")
  aiUpdatePolicy        Json?               @map("ai_update_policy") // { mode: "EVERY_N_MESSAGES" | "EVERY_X_MINUTES", n?: number, minutes?: number }
  messagesSinceLastAI   Int                 @default(0) @map("messages_since_last_ai")

  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  // Relations
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead          Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  assignedAgent User?     @relation("AssignedAgent", fields: [assignedAgentId], references: [id], onDelete: SetNull)
  messages      Message[]

  @@index([tenantId])
  @@index([leadId])
  @@index([assignedAgentId])
  @@index([lastMessageAt])
  @@index([aiPriority])
  @@index([status])
  @@map("conversations")
}

model Message {
  id                String            @id @default(uuid())
  tenantId          String            @map("tenant_id")
  conversationId    String            @map("conversation_id")
  senderType        SenderType        @map("sender_type")
  senderUserId      String?           @map("sender_user_id")
  contentText       String            @map("content_text")
  contentType       ContentType       @default(TEXT) @map("content_type")
  mediaUrl          String?           @map("media_url")
  externalProvider  WhatsAppProvider? @map("external_provider")
  externalMessageId String?           @map("external_message_id")
  status            MessageStatus     @default(PENDING)
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  // Relations
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderUser   User?        @relation(fields: [senderUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([conversationId])
  @@index([senderUserId])
  @@index([externalMessageId])
  @@map("messages")
}
